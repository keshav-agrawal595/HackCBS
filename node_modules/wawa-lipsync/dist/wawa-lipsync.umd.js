(function(h,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(h=typeof globalThis<"u"?globalThis:h||self,c(h["Wawa-lipsync"]={}))})(this,function(h){"use strict";var F=Object.defineProperty;var S=(h,c,e)=>c in h?F(h,c,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[c]=e;var r=(h,c,e)=>S(h,typeof c!="symbol"?c+"":c,e);function c(n){return n.length?n.reduce((t,s)=>t+s,0)/n.length:0}var e=(n=>(n.sil="viseme_sil",n.PP="viseme_PP",n.FF="viseme_FF",n.TH="viseme_TH",n.DD="viseme_DD",n.kk="viseme_kk",n.CH="viseme_CH",n.SS="viseme_SS",n.nn="viseme_nn",n.RR="viseme_RR",n.aa="viseme_aa",n.E="viseme_E",n.I="viseme_I",n.O="viseme_O",n.U="viseme_U",n))(e||{});const x={[e.sil]:"silence",[e.PP]:"plosive",[e.FF]:"fricative",[e.TH]:"fricative",[e.DD]:"plosive",[e.kk]:"plosive",[e.CH]:"fricative",[e.SS]:"fricative",[e.nn]:"plosive",[e.RR]:"fricative",[e.aa]:"vowel",[e.E]:"vowel",[e.I]:"vowel",[e.O]:"vowel",[e.U]:"vowel"};class w{constructor(t={fftSize:2048,historySize:10}){r(this,"features",null);r(this,"viseme",e.sil);r(this,"audioContext");r(this,"analyser");r(this,"dataArray");r(this,"history");r(this,"historySize");r(this,"sampleRate");r(this,"binWidth");r(this,"bands");r(this,"audioSource");r(this,"state","silence");r(this,"visemeStartTime",0);r(this,"maxVisemeDuration",100);const{fftSize:s=2048,historySize:d=10}=t;this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=s,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.history=[],this.historySize=d,this.sampleRate=this.audioContext.sampleRate,this.binWidth=this.sampleRate/s,this.bands=[{start:50,end:200},{start:200,end:400},{start:400,end:800},{start:800,end:1500},{start:1500,end:2500},{start:2500,end:4e3},{start:4e3,end:8e3}]}connectAudio(t){if(this.audioContext.resume(),this.history=[],this.features=null,this.state="silence",this.visemeStartTime=performance.now(),this.audioSource===t)return;if(this.audioSource=t,!t.src){console.warn("An audio source must be set before connecting");return}this.audioContext.createMediaElementSource(t).connect(this.analyser),this.analyser.connect(this.audioContext.destination)}async connectMicrophone(){try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),s=this.audioContext.createMediaStreamSource(t);return s.connect(this.analyser),this.analyser.connect(this.audioContext.destination),s}catch(t){throw console.error("Error accessing microphone:",t),t}}extractFeatures(){this.analyser.getByteFrequencyData(this.dataArray);const t=this.bands.map(({start:a,end:l})=>{const u=Math.round(a/this.binWidth),g=Math.min(Math.round(l/this.binWidth),this.dataArray.length-1);return c(Array.from(this.dataArray.slice(u,g)))/255});let s=0,d=0;for(let a=0;a<this.dataArray.length;a++){const l=a*this.binWidth,u=this.dataArray[a]/255;s+=u,d+=l*u}const o=s>0?d/s:0,i=c(t),y=t.map((a,l)=>{if(this.history.length<2)return 0;const u=this.history[this.history.length-2].bands[l];return a-u}),f={bands:t,deltaBands:y,volume:i,centroid:o};return s>0&&(this.history.push(f),this.history.length>this.historySize&&this.history.shift()),f}getAveragedFeatures(){const t=this.history.length,s={volume:0,centroid:0,bands:Array(this.bands.length).fill(0)};for(const o of this.history)s.volume+=o.volume,s.centroid+=o.centroid,o.bands.forEach((i,y)=>s.bands[y]+=i);const d=s.bands.map(o=>o/t);return{volume:s.volume/t,centroid:s.centroid/t,bands:d,deltaBands:d}}detectState(){const t=this.history[this.history.length-1];if(!t){this.state="silence",this.viseme=e.sil;return}const s=this.getAveragedFeatures(),d=t.volume-s.volume,o=t.centroid-s.centroid,i=this.computeVisemeScores(t,s,d,o),y=this.adjustScoresForConsistency(i);let f=-1/0,a=e.sil;for(const u in y)y[u]>f&&(f=y[u],a=u);let l=x[a];a!==this.viseme&&(this.visemeStartTime=performance.now()),this.state=l,this.viseme=a}computeVisemeScores(t,s,d,o){const i={[e.sil]:0,[e.PP]:0,[e.FF]:0,[e.TH]:0,[e.DD]:0,[e.kk]:0,[e.CH]:0,[e.SS]:0,[e.nn]:0,[e.RR]:0,[e.aa]:0,[e.E]:0,[e.I]:0,[e.O]:0,[e.U]:0},[y,f,a,l,u,g,A]=t.bands;if(s.volume<.2&&t.volume<.2&&(i[e.sil]=1),Object.entries(x).forEach(([p,v])=>{v==="plosive"&&(d<.01&&(i[p]-=.5),s.volume<.2&&(i[p]+=.2),o>1e3&&(i[p]+=.2))}),t.centroid>1e3&&t.centroid<8e3&&(t.centroid>7e3?i[e.DD]+=.6:t.centroid>5e3?i[e.kk]+=.6:t.centroid>4e3?(i[e.PP]+=1,A>.25&&t.centroid<6e3&&(i[e.DD]+=1.4)):i[e.nn]+=.6),o>1e3&&t.centroid>6e3&&s.centroid>5e3&&t.bands[6]>.4&&s.bands[6]>.3&&(i[e.FF]=.7),s.volume>.1&&s.centroid<6e3&&t.centroid<6e3){const[p,v,m,b,_]=s.bands,C=Math.abs(p-v),D=Math.max(Math.abs(v-m),Math.abs(v-b),Math.abs(m-b));(m>.1||b>.1)&&(b>m&&(i[e.aa]=.8,m>v&&(i[e.aa]+=.2)),m>v&&m>b&&(i[e.I]=.7),C<.25&&(i[e.U]=.7),D<.25&&(i[e.O]=.9),v>m&&m>b&&(i[e.E]=1),m<.2&&b>.3&&(i[e.I]=.7),m>.25&&_>.25&&(i[e.O]=.7),m<.15&&_<.15&&(i[e.U]=.7))}return i}adjustScoresForConsistency(t){const s={...t};if(this.viseme&&this.state){const o=performance.now()-this.visemeStartTime;for(const i in s)if(i===this.viseme){let f;if(o<=100)f=1.3;else if(o<=this.maxVisemeDuration){const l=this.maxVisemeDuration-100;f=1.3-.3*((o-100)/l)}else{const l=o-this.maxVisemeDuration;f=Math.max(.5,1-l/1e3)}s[i]*=f}}return s}processAudio(){this.features=this.extractFeatures(),this.detectState()}}h.Lipsync=w,h.VISEMES=e,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
