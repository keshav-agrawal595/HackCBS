# System Architecture - Vision Integration

## Overall Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                          â”‚
â”‚                      (React Frontend)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Chat UI   â”‚  â”‚  Avatar 3D  â”‚  â”‚  Vision Indicator    â”‚  â”‚
â”‚  â”‚   Input     â”‚  â”‚  Animation  â”‚  â”‚  "Analyzing..."      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP Request
                              â”‚ (message + videoUrl)
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BACKEND SERVER                           â”‚
â”‚                      (Node.js + Express)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Receive message from frontend                        â”‚  â”‚
â”‚  â”‚  2. Check for trigger keywords                           â”‚  â”‚
â”‚  â”‚  3. If triggered â†’ Call Vision Service                   â”‚  â”‚
â”‚  â”‚  4. Process response with Gemini AI                      â”‚  â”‚
â”‚  â”‚  5. Generate speech with ElevenLabs                      â”‚  â”‚
â”‚  â”‚  6. Create lip sync with Rhubarb                         â”‚  â”‚
â”‚  â”‚  7. Send back: text + audio + lipsync + animation        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                 â”‚
          â”‚ Call Vision API                 â”‚ Call AI APIs
          â”‚ (if triggered)                  â”‚
          â†“                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VISION SERVICE     â”‚        â”‚   EXTERNAL APIS           â”‚
â”‚  (Python Flask)     â”‚        â”‚                           â”‚
â”‚                     â”‚        â”‚  â€¢ Gemini AI (chat)       â”‚
â”‚  1. Capture frames  â”‚        â”‚  â€¢ ElevenLabs (TTS)       â”‚
â”‚  2. Filter quality  â”‚        â”‚  â€¢ Gemini Vision (image)  â”‚
â”‚  3. Combine images  â”‚        â”‚                           â”‚
â”‚  4. Call Gemini     â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  5. Return desc     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Video Stream
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   VIDEO SOURCE      â”‚
â”‚                     â”‚
â”‚  â€¢ Phone Camera     â”‚
â”‚  â€¢ IP Webcam App    â”‚
â”‚  â€¢ DroidCam         â”‚
â”‚  â€¢ Local Webcam     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow for Vision Request

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: User Input                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User types: "visualize the environment"                         â”‚
â”‚ Frontend: Detects trigger keyword                               â”‚
â”‚ Frontend: Sets isAnalyzingVision = true                         â”‚
â”‚ Frontend: Shows "Analyzing surroundings..." spinner             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Backend Processing                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend receives: { message, videoUrl }                         â”‚
â”‚ Backend: Checks shouldTriggerVision()                           â”‚
â”‚ Backend: Calls POST http://localhost:5000/analyze-environment   â”‚
â”‚ Backend: Waits for vision service response...                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Vision Service Processing                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Vision Service receives: { video_url }                          â”‚
â”‚                                                                  â”‚
â”‚ Loop (capture 6 clear frames):                                  â”‚
â”‚   â€¢ Read frame from video stream                                â”‚
â”‚   â€¢ Check if clear (blur detection)                             â”‚
â”‚   â€¢ Check for motion (optical flow)                             â”‚
â”‚   â€¢ Add to buffer if quality OK                                 â”‚
â”‚                                                                  â”‚
â”‚ After capturing:                                                â”‚
â”‚   â€¢ Combine 6 frames horizontally                               â”‚
â”‚   â€¢ Save as single image                                        â”‚
â”‚   â€¢ Encode to base64                                            â”‚
â”‚   â€¢ Send to Gemini Vision API with prompt                       â”‚
â”‚                                                                  â”‚
â”‚ Returns: { success, description, frames_captured, image_path }  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: Backend Response Generation                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend receives vision description                             â”‚
â”‚ Backend: Creates natural prompt with description                â”‚
â”‚ Backend: Calls Gemini AI for conversational response            â”‚
â”‚ Backend: Generates speech with ElevenLabs                       â”‚
â”‚ Backend: Creates lip sync with Rhubarb                          â”‚
â”‚                                                                  â”‚
â”‚ Prepares response:                                              â”‚
â”‚   {                                                              â”‚
â”‚     messages: [                                                  â”‚
â”‚       {                                                          â”‚
â”‚         text: "Looking around, I can see...",                   â”‚
â”‚         audio: base64_audio_data,                               â”‚
â”‚         lipsync: mouth_cue_data,                                â”‚
â”‚         facialExpression: "smile",                              â”‚
â”‚         animation: "Talking_1"                                  â”‚
â”‚       }                                                          â”‚
â”‚     ]                                                            â”‚
â”‚   }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: Frontend Playback                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend receives response                                      â”‚
â”‚ Frontend: Sets isAnalyzingVision = false                        â”‚
â”‚ Frontend: Hides spinner, shows normal UI                        â”‚
â”‚ Frontend: Starts avatar playback                                â”‚
â”‚                                                                  â”‚
â”‚ Avatar:                                                          â”‚
â”‚   â€¢ Plays audio (description)                                   â”‚
â”‚   â€¢ Syncs mouth movements (lip sync)                            â”‚
â”‚   â€¢ Shows facial expression (smile)                             â”‚
â”‚   â€¢ Performs animation (Talking_1)                              â”‚
â”‚                                                                  â”‚
â”‚ User hears: Natural description of environment                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Trigger Detection Flow

```
User Message: "Hey, can you visualize the environment?"
                â”‚
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend Trigger Check       â”‚
â”‚  (Screen.jsx, line 68)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  const visionTriggers = [     â”‚
â”‚    'visualize',               â”‚
â”‚    'look around',             â”‚
â”‚    'what do you see',         â”‚
â”‚    ...                        â”‚
â”‚  ]                            â”‚
â”‚                               â”‚
â”‚  isVisionRequest =            â”‚
â”‚    triggers.some(trigger =>   â”‚
â”‚      message.includes(trigger)â”‚
â”‚    )                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Triggered? â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
      â”‚         â”‚
     YES       NO
      â”‚         â”‚
      â†“         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Add     â”‚  â”‚ Send normal  â”‚
â”‚ videoUrlâ”‚  â”‚ request      â”‚
â”‚ to      â”‚  â”‚ without      â”‚
â”‚ request â”‚  â”‚ videoUrl     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend Trigger Check  â”‚
â”‚  (index.js, line 187)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  shouldTriggerVision(   â”‚
â”‚    userMessage          â”‚
â”‚  )                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Call   â”‚
    â”‚ Vision â”‚
    â”‚ Serviceâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   UI.jsx     â”‚         â”‚   Screen.jsx                â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ â€¢ Input box  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ â€¢ handleSendMessage()       â”‚    â”‚
â”‚  â”‚ â€¢ Send btn   â”‚         â”‚ â€¢ Trigger detection         â”‚    â”‚
â”‚  â”‚ â€¢ Spinner    â”‚         â”‚ â€¢ API calls                 â”‚    â”‚
â”‚  â”‚ â€¢ Messages   â”‚         â”‚ â€¢ Chat history              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â–²                               â”‚                     â”‚
â”‚         â”‚                               â”‚                     â”‚
â”‚         â”‚                               â†“                     â”‚
â”‚         â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚         â”‚                  â”‚   useChat.jsx              â”‚    â”‚
â”‚         â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â€¢ loading                  â”‚    â”‚
â”‚                            â”‚ â€¢ isAnalyzingVision        â”‚    â”‚
â”‚                            â”‚ â€¢ message queue            â”‚    â”‚
â”‚                            â”‚ â€¢ startBotResponse()       â”‚    â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                       â”‚                       â”‚
â”‚                                       â†“                       â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                            â”‚   Experience.jsx           â”‚    â”‚
â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚                            â”‚ â€¢ 3D Avatar                â”‚    â”‚
â”‚                            â”‚ â€¢ Audio playback           â”‚    â”‚
â”‚                            â”‚ â€¢ Lip sync                 â”‚    â”‚
â”‚                            â”‚ â€¢ Animations               â”‚    â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Dependencies

```
vision-service.py
  â”œâ”€â”€ requirements-vision.txt
  â”‚     â”œâ”€â”€ flask
  â”‚     â”œâ”€â”€ flask-cors
  â”‚     â”œâ”€â”€ opencv-python
  â”‚     â”œâ”€â”€ torch
  â”‚     â”œâ”€â”€ torchvision
  â”‚     â”œâ”€â”€ pillow
  â”‚     â”œâ”€â”€ imagehash
  â”‚     â”œâ”€â”€ aiohttp
  â”‚     â””â”€â”€ python-dotenv
  â””â”€â”€ .env (GEMINI_API_KEY)

backend-gemini/index.js
  â”œâ”€â”€ package.json
  â”‚     â”œâ”€â”€ express
  â”‚     â”œâ”€â”€ cors
  â”‚     â”œâ”€â”€ axios
  â”‚     â”œâ”€â”€ @google/generative-ai
  â”‚     â”œâ”€â”€ mongoose
  â”‚     â””â”€â”€ dotenv
  â”œâ”€â”€ .env (GEMINI_API_KEY, ELEVEN_LABS_API_KEY, MONGODB_URI)
  â”œâ”€â”€ routes/
  â”‚     â”œâ”€â”€ authRoutes.js
  â”‚     â””â”€â”€ chatRoutes.js
  â”œâ”€â”€ middleware/
  â”‚     â””â”€â”€ authMiddleware.js
  â””â”€â”€ models/
        â”œâ”€â”€ user.js
        â””â”€â”€ Chat.js

frontend/
  â”œâ”€â”€ package.json
  â”‚     â”œâ”€â”€ react
  â”‚     â”œâ”€â”€ three
  â”‚     â”œâ”€â”€ @react-three/fiber
  â”‚     â””â”€â”€ vite
  â””â”€â”€ src/
        â”œâ”€â”€ components/
        â”‚     â”œâ”€â”€ UI.jsx (âœï¸ modified)
        â”‚     â”œâ”€â”€ Experience.jsx
        â”‚     â””â”€â”€ HomeScreen/
        â”‚           â””â”€â”€ Screen.jsx (âœï¸ modified)
        â”œâ”€â”€ hooks/
        â”‚     â””â”€â”€ useChat.jsx (âœï¸ modified)
        â””â”€â”€ context/
              â””â”€â”€ AuthContext.jsx
```

## Service Ports

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service                 â”‚ Port     â”‚ Purpose             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Vision Service (Python) â”‚ 5000     â”‚ Frame capture       â”‚
â”‚                         â”‚          â”‚ & analysis          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend (Node.js)       â”‚ 3000     â”‚ Chat API            â”‚
â”‚                         â”‚          â”‚ Auth, History       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend (Vite)         â”‚ 5173     â”‚ User Interface      â”‚
â”‚                         â”‚ (varies) â”‚                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MongoDB                 â”‚ 27017    â”‚ Database            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Video Stream (Phone)    â”‚ 8080     â”‚ Camera feed         â”‚
â”‚                         â”‚ (varies) â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Global State (ChatContext)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  loading: boolean                                         â”‚
â”‚    â€¢ true when API call in progress                       â”‚
â”‚    â€¢ false when idle                                      â”‚
â”‚                                                           â”‚
â”‚  isAnalyzingVision: boolean                               â”‚
â”‚    â€¢ true when vision analysis in progress                â”‚
â”‚    â€¢ false otherwise                                      â”‚
â”‚                                                           â”‚
â”‚  message: object | null                                   â”‚
â”‚    â€¢ Currently playing message                            â”‚
â”‚    â€¢ null when no message playing                         â”‚
â”‚                                                           â”‚
â”‚  messagesQueue: array                                     â”‚
â”‚    â€¢ Queue of messages to play                            â”‚
â”‚    â€¢ Avatar plays first message                           â”‚
â”‚    â€¢ Shifts after each message completes                  â”‚
â”‚                                                           â”‚
â”‚  cameraZoomed: boolean                                    â”‚
â”‚    â€¢ Controls 3D camera position                          â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Local State (Screen.jsx)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  messages: array                                          â”‚
â”‚    â€¢ Chat history for display                             â”‚
â”‚    â€¢ [{role: 'user', content: '...'}, ...]               â”‚
â”‚                                                           â”‚
â”‚  currentChatId: string | null                             â”‚
â”‚    â€¢ ID of current conversation                           â”‚
â”‚                                                           â”‚
â”‚  sidebarRefreshKey: number                                â”‚
â”‚    â€¢ Forces sidebar refresh on save                       â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Endpoints

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend Endpoints (http://localhost:3000)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ GET  /                                                      â”‚
â”‚   â†’ Hello World (health check)                             â”‚
â”‚                                                             â”‚
â”‚ POST /api/auth/signup                                       â”‚
â”‚   â†’ Create new user account                                â”‚
â”‚                                                             â”‚
â”‚ POST /api/auth/login                                        â”‚
â”‚   â†’ Login and get JWT token                                â”‚
â”‚                                                             â”‚
â”‚ POST /api/chat  [Protected] ğŸ”’                             â”‚
â”‚   Body: { message, videoUrl? }                             â”‚
â”‚   â†’ Process chat message                                   â”‚
â”‚   â†’ Call vision service if triggered                       â”‚
â”‚   â†’ Return: { messages: [...] }                            â”‚
â”‚                                                             â”‚
â”‚ GET  /api/chat-history  [Protected] ğŸ”’                     â”‚
â”‚   â†’ Get all user's chat sessions                           â”‚
â”‚                                                             â”‚
â”‚ GET  /api/chat-history/:id  [Protected] ğŸ”’                 â”‚
â”‚   â†’ Get specific chat session                              â”‚
â”‚                                                             â”‚
â”‚ POST /api/chat-history  [Protected] ğŸ”’                     â”‚
â”‚   Body: { messages, chatId?, title }                       â”‚
â”‚   â†’ Save/update chat session                               â”‚
â”‚                                                             â”‚
â”‚ GET  /voices                                                â”‚
â”‚   â†’ List ElevenLabs voices                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vision Service Endpoints (http://localhost:5000)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ GET  /health                                                â”‚
â”‚   â†’ Health check                                           â”‚
â”‚   Returns: { status: "healthy", service: "vision-service" }â”‚
â”‚                                                             â”‚
â”‚ POST /analyze-environment                                   â”‚
â”‚   Body: { video_url }                                      â”‚
â”‚   â†’ Capture frames from video                              â”‚
â”‚   â†’ Analyze with Gemini Vision                             â”‚
â”‚   Returns: {                                               â”‚
â”‚     success: true,                                         â”‚
â”‚     description: "...",                                    â”‚
â”‚     image_path: "captured_frames/...",                     â”‚
â”‚     frames_captured: 6                                     â”‚
â”‚   }                                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Timing Diagram

```
User sends vision request
â”‚
â”œâ”€ 0ms: Frontend receives input
â”‚  â””â”€ Shows "Analyzing..." spinner
â”‚
â”œâ”€ ~100ms: Request reaches backend
â”‚  â””â”€ Detects trigger keyword
â”‚
â”œâ”€ ~200ms: Backend calls vision service
â”‚
â”œâ”€ 5-15s: Vision service captures frames
â”‚  â”œâ”€ Capture frame 1
â”‚  â”œâ”€ Capture frame 2
â”‚  â”œâ”€ Capture frame 3
â”‚  â”œâ”€ Capture frame 4
â”‚  â”œâ”€ Capture frame 5
â”‚  â””â”€ Capture frame 6
â”‚
â”œâ”€ ~500ms: Combine and save frames
â”‚
â”œâ”€ 5-10s: Gemini Vision API analyzes
â”‚  â””â”€ Returns description
â”‚
â”œâ”€ ~200ms: Backend receives description
â”‚  â””â”€ Creates conversational prompt
â”‚
â”œâ”€ 3-5s: Gemini AI generates response
â”‚
â”œâ”€ 2-4s: ElevenLabs generates audio
â”‚
â”œâ”€ 1-2s: Rhubarb generates lip sync
â”‚
â”œâ”€ ~500ms: Response sent to frontend
â”‚
â””â”€ User sees/hears response
   â”œâ”€ Spinner disappears
   â”œâ”€ Avatar starts speaking
   â””â”€ Description plays with animation

Total Time: 10-30 seconds
```

This architecture provides a seamless integration of vision capabilities
into your existing AI co-passenger system! ğŸš—ğŸ‘ï¸ğŸ¤–
